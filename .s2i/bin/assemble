#!/bin/bash

# this assemble script will run "around" the standard python/django s2i assemble script to do a couple of things:
# - install some additional dependencies/plugins that we want for our deployment
# - "overlay" some  deployment-related files that will help us deploy the app in OpenShift/k8s

# where are we?
echo "Current dir $(pwd)"

# what's in /tmp/src?
echo "Contents of /tmp/src"
ls -la /tmp/src

# copy required additional files to the current working directory
cp -r /tmp/src/openshift/.s2i/* /tmp/src

# what's in /tmp/src?
echo "Contents of /tmp/src"
ls -la /tmp/src


# additional dependencies
pip install -r requirements.txt

# overlay files
if [ -d "./overlay" ]; then
    echo "Copying overlay files into place..."
    cp -R ./overlay/settings/* ../../settings
    cp -R ./overlay/gunicorn_config.py ../../
    cp -R ./overlay/wsgi.py ../../
    find ../../
fi

echo "Running default assemble script..."

/usr/libexec/s2i/assemble
rc=$?

if [ $rc -eq 0 ]; then
    echo "Default assemble succeeded."
else
    echo "Default assemble  failed."
fi

echo "Assemble done."

exit $rc
